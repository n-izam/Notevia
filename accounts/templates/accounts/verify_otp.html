<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verify OTP</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f8f9fa;
    }
    .otp-container {
      width: 100%;
      max-width: 400px;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0px 2px 10px rgba(0,0,0,0.1);
    }
    .btn-black {
      background-color: #000;
      color: #fff;
    }
    .btn-black:hover {
      background-color: #333;
      color: #fff;
    }

    /* Toast container responsiveness */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 5000;
    }

    @media (max-width: 576px) {
        .toast-container {
            top: auto !important;
            bottom: 1rem !important;
            right: 50% !important;
            transform: translateX(50%);
            width: 90%;
        }
    }

    /* Base Toast Style */
    .toast {
        backdrop-filter: blur(8px);
        background: rgba(17, 17, 17, 0.85) !important; /* glassy black */
        color: #fff !important;
        border-radius: 12px !important;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.35);
        animation: slideFadeIn 0.5s ease-out;
    }

    /* Toast body text */
    .toast-body {
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* SUCCESS */
    .toast.bg-success {
        background: rgba(0, 255, 100, 0.15) !important;
        border-left: 4px solid #00ff73 !important;
        color: #409365 !important;
    }

    /* ERROR */
    .toast.bg-danger {
        background: rgba(255, 0, 0, 0.15) !important;
        border-left: 4px solid #ff3b3b !important;
        color: #bb4141 !important;
    }

    /* WARNING */
    .toast.bg-warning {
        background: rgba(255, 193, 7, 0.15) !important;
        border-left: 4px solid #ffc107 !important;
        color: #a1842f !important;
    }

    /* INFO */
    .toast.bg-info {
        background: rgba(0, 200, 255, 0.15) !important;
        border-left: 4px solid #00cfff !important;
        color: #3092a8 !important;
    }

    /* Beautiful animation */
    @keyframes slideFadeIn {
        0% {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0px) scale(1);
        }
    }
  </style>
</head>
<body>
  <div class="otp-container text-center">
    <h3 class="mb-3 fw-bold">Verify OTP</h3>
    {% if request.resolver_match.url_name == 'verify_new_mail' %}
    <p class="text-muted">We’ve sent a 6-digit OTP to your email {{email}}.</p>
    {% else %}
    <p class="text-muted">We’ve sent a 6-digit OTP to your email {{user.email}}.</p>
    {% endif %}

    <!-- OTP Form -->
    {% if request.resolver_match.url_name == 'verify_new_mail' %}
    <form method="post" action="{% url 'verify_new_mail' %}" novalidate>
    {% else %}
    <form method="post" action="{% url 'verify_profile' %}" novalidate>
    {% endif %}
      {% csrf_token %}
      {% if request.resolver_match.url_name == 'verify_new_mail' %}
      {% else %}
      <input type="hidden" name="user_id" value="{{ user_id }}">
      {% endif %}

      
      <div class="mb-3 text-start">
        <label class="form-label">Enter OTP</label>
        <input type="text" name="otp" class="form-control" placeholder="6-digit OTP" required>
      </div>

      <!-- Toast container (fixed position) -->
      <div class="toast-container">
        {% if messages %}
            {% for message in messages %}
                <div class="toast align-items-center border-0 mb-2
                    {% if message.tags == 'error' %} bg-danger
                    {% elif message.tags == 'success' %} bg-success 
                    {% elif message.tags == 'warning' %} bg-warning 
                    {% else %} bg-info
                    {% endif %}
                ">
                    <div class="d-flex">
                        <div class="toast-body">
                        {% if message.tags == 'error' %}<i class="bi bi-x-circle-fill me-2"></i>
                        {% elif message.tags == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>
                        {% elif message.tags == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>{% endif %}
                            {{ message }}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

      <button type="submit" class="btn btn-black w-100 mt-2">Verify</button>
    </form>

    <p id="timer"></p>
    <!-- Resend OTP -->
    <p class="small mt-3">
      Didn’t get the OTP? 
      {% if request.resolver_match.url_name == 'verify_new_mail' %}
      <a href="{% url 'resend_new_mail_otp' %}" class="fw-bold">Resend OTP</a>
      {% else %}
      <a href="{% url 'resend_profile' %}" class="fw-bold">Resend OTP</a>
      {% endif %}
    </p>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <!-- <script>
    // If the page is loaded from the browser's back/forward cache
    window.addEventListener("pageshow", () => {
      const nav = performance.getEntriesByType("navigation")[0];
      if (nav && nav.type === "back_forward") {
          window.location.reload();
      }
  });
  
  </script> -->
  <script>
    window.addEventListener("pageshow", function(event) {
      //If the page is loaded from the browser's back/forward cache
      if (event.persisted) {
          window.location.reload();
      }
  });
  </script>
  <script>
    const expiryTime = Number("{{ expiry|default:0 }}") * 1000;
  
    function startTimer() {
        let timer = setInterval(function () {
            let now = Date.now();
            let timeLeft = Math.floor((expiryTime - now) / 1000);
  
            if (timeLeft <= 0) {
                clearInterval(timer);
                document.getElementById("timer").innerHTML = "OTP expired, please resend.";
            } else {
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
  
                // Add leading zero for seconds
                seconds = seconds < 10 ? "0" + seconds : seconds;
  
                document.getElementById("timer").innerHTML = "Expires in " + minutes + ":" + seconds;
            }
  
        }, 1000);
    }
  
    startTimer();
  </script>
  <!-- <script>
    // Detect if user navigated from a different page
    if (performance.navigation.type !== performance.navigation.TYPE_RELOAD) {
        // Fresh visit → clear old expiry from backend on next visit
        fetch("/reset-otp-expiry/");
    }
  </script> -->
  <!-- toast -->
  <script>

      document.addEventListener('DOMContentLoaded', () => {
          document.querySelectorAll('.toast').forEach(el => {
              new bootstrap.Toast(el).show();
          });
      });

      
  </script>
</body>
</html>
