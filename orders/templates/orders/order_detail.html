{% extends 'base_user.html' %}
{% load static %}

{% block title %} Order Details {% endblock %}

{% block style %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="{% static 'css/profile_style.css' %}">

<style>
    .order-details-container {
        font-family: sans-serif;
    }
    
    .summary-card,
    .order-list-card {
        background-color: #fff;
        border-radius: 1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .status-pending { color: #f1a831; background-color: rgba(230, 201, 60, 0.296); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
    .status-shipped { color: #2883a7; background-color: rgba(40, 167, 159, 0.1); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
    .status-cancelled { color: #a73128; background-color: rgba(167, 40, 40, 0.1); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
    .status-deliverd { color: #28a745; background-color: rgba(186, 72, 37, 0.1); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
    
    .product-count {
        background-color: #e9ecef;
        color: #495057;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.8em;
    }
    
    .product-item { border-bottom: 1px solid #dee2e6; }
    .product-item:last-child { border-bottom: none; }
    
    .product-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e9ecef;
    }
    
    .sku-link { color: #0d6efd; text-decoration: none; font-weight: bold; }
    .sku-link:hover { text-decoration: underline; }
    .totals-section { border-top: 1px solid #dee2e6; }

    /* Buttons */
    .rating-btn, .return-item-btn {
        display: inline-block;
        padding: 5px 14px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.25s ease;
        color: #fff;
    }
    .rating-btn { background-color: #ff9138e0; }
    .rating-btn:hover { background-color: #f0be8f; color: #b95722; transform: translateY(-2px); }
    .return-item-btn { background-color: #ff5338e0; }
    .return-item-btn:hover { background-color: #f9b6a3; color: #9f0b0b; transform: translateY(-2px); }

    /* Scrollable Wrapper */
    .scrollable-requests-wrapper {
        max-height: 480px; 
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 5px;
        padding-bottom: 10px;
    }
    .scrollable-requests-wrapper::-webkit-scrollbar { width: 6px; }
    .scrollable-requests-wrapper::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrollable-requests-wrapper::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }

    .request-management-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }
    .request-management-card .card-title-secondary { font-weight: 600; font-size: 1.1rem; border-bottom: 1px solid #e9ecef; padding-bottom: 0.75rem; margin-bottom: 1rem; color: #333; }
    .request-management-card .reason-quote { border-left: 3px solid #6c757d; padding: 5px 10px; margin: 0.5rem 0 1rem 0; font-style: italic; font-size: 0.95rem; color: #555; background-color: #f8f9fa; }

    /* ============================================================
       RESPONSIVE ADJUSTMENTS
       ============================================================ */
    @media (max-width: 991px) {
        .product-image { width: 80px; height: 80px; }
    }

    @media (max-width: 768px) {
        .summary-card, .order-list-card { padding: 1.25rem !important; }
        .product-image { width: 70px; height: 70px; }
        .h2 { font-size: 1.5rem; }
        .request-management-card { padding: 1rem; }
        .product-count { font-size: 0.7rem; }
    }

    @media (max-width: 576px) {
        .product-image { width: 60px; height: 60px; }
        .order-details-container p, .order-details-container span, .order-details-container div {
            font-size: 0.85rem;
        }
        .order-details-container h2 { font-size: 1.25rem; }
        .order-details-container h5, .order-details-container h6 { font-size: 1rem; }
        
        /* Stack small info in product row */
        .product-item .fw-bold { font-size: 0.85rem; }
        .product-item .text-muted { font-size: 0.75rem; }
        
        .rating-btn, .return-item-btn {
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .btn-lg { padding: 0.5rem; font-size: 0.9rem; }
    }
</style>
{% endblock %}

{% block content2 %}
<div class="col-lg-9">
    <div class="container my-3 my-md-5 order-details-container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3 mb-md-4">
            <ol class="breadcrumb small">
                {% for crumb in breadcrumb %}
                    {% if forloop.last %}
                        <li class="breadcrumb-item active" aria-current="page">{{ crumb.name }}</li>
                    {% else %}
                        <li class="breadcrumb-item"><a href="{{ crumb.url }}">{{ crumb.name }}</a></li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
    
        <h2 class="mb-3 mb-md-4 fw-bold">Order Details</h2>
    
        <div class="row">
            <!-- Left Column: Order Summary -->
            <div class="col-lg-4 mb-4">
                <div class="summary-card p-3 p-md-4">
                    <p class="fw-bold mb-1">Order# {{order.order_id}}</p>
                    <p class="text-muted small mb-3">Ordered on {{ order.created_at|date:"j F Y" }}</p>
                    
                    <hr class="my-2">
                    <div class="d-flex justify-content-between">
                        <h6 class="fw-bold small">Shipping Address</h6>
                        <h6 class="fw-bold small text-end">Payment Method</h6>
                    </div>
                    <div class="d-flex justify-content-between gap-2">
                        <p class="text-muted extra-small" style="font-size: 0.8rem; line-height: 1.4;">
                            <strong>{{order.orders_address.address_type}}</strong><br>
                            {{order.orders_address.full_name}}<br>
                            {{order.orders_address.address}}<br>
                            {{order.orders_address.city}}, {{order.orders_address.district}}<br>
                            {{order.orders_address.state}} - {{order.orders_address.pin_code}}<br>
                            Ph: {{order.orders_address.phone_no}}
                        </p>
                        <p class="text-muted small text-end">
                            {{order.payment_method}}<br>
                            {% if order.is_paid %}
                            <span class="badge bg-success rounded-1 p-1">Paid</span>
                            {% endif %}
                        </p>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between py-1 fw-bold h6 mb-0">
                        <span>Order Total</span>
                        <span>₹{{order.over_all_amount_all}}</span>
                    </div>
                    {% if order.return_price %}
                    <div class="d-flex justify-content-between py-1 fw-light mb-0">
                        <span>Return Total</span>
                        <span>₹{{order.return_price}}</span>
                    </div>
                    {% endif %}
                    {% if order.total_cancel_amount %}
                            <div class="d-flex justify-content-between py-1 fw-light mb-0">
                                <span>Cancel Total</span>
                                <span>₹{{order.total_cancel_amount}}</span>
                            </div>
                    {% endif %}
                    <hr class="my-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 small">Status :</h6>
                        {% if order.status == 'Delivered' %}<div class="status-deliverd">{{order.status}}</div>
                        {% elif order.status == 'Pending' or order.status == 'Processing' %}<div class="status-pending">{{order.status}}</div>
                        {% elif order.status == 'Cancelled' %}<div class="status-cancelled">{{order.status}}</div>
                        {% elif order.status == 'Shipped' %}<div class="status-shipped">{{order.status}}</div>
                        {% elif order.status == 'Returned' %}<div class="status-pending">{{order.status}}</div>
                        {% endif %}
                    </div>
                    <div class="d-grid mt-3">
                        <a href="{% url 'order_tracking' order.id %}" class="btn btn-dark btn-md">Track Order</a>
                    </div>
                </div>

                {% if order.cancel_reason or order.return_requests.reason %}
                <div class="request-management-card mt-3">
                    <h5 class="card-title-secondary small">{% if order.return_requests.reason %}Return Request{% else %}Cancellation Reason{% endif %}</h5>
                    <p class="text-muted small mb-1"><strong>Reason Given:</strong></p>
                    <blockquote class="reason-quote">{{ order.cancel_reason|default:order.return_requests.reason }}</blockquote>
                    {% if order.return_requests.reason %}
                        <hr class="my-2"><p class="mb-0 small"><strong>Status:</strong> <span class="badge bg-secondary">{{ order.return_requests.status }}</span></p>
                    {% endif %}
                </div>
                {% elif return_item_requests %}
                <div class="scrollable-requests-wrapper">
                    {% for item_request in return_item_requests %}
                    <div class="request-management-card mt-3">
                        <h5 class="card-title-secondary small">Return Item Request</h5>
                        <p class="text-muted mb-1"><small>{{ item_request.order_item }}</small></p>
                        <p class="text-muted mb-1"><small><strong>Reason Given:</strong></small></p>
                        <blockquote class="reason-quote small">{{ item_request.reason }}</blockquote>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center small">
                            <span class="text-muted">Status:</span> 
                            <span class="badge bg-secondary">{{ item_request.status }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
    
            <!-- Right Column: Order List & Totals -->
            <div class="col-lg-8">
                <div class="order-list-card p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Order List <span class="product-count">{{order.items.count}}</span></h5>
                        {% if order.status == 'Delivered' %}
                        <a href="{% url 'download_invoice' order.id %}" class="btn btn-sm btn-outline-dark"><i class="fas fa-file-invoice me-1"></i>Invoice</a>
                        {% endif %}
                    </div>

                    <!-- Desktop Header -->
                    <div class="d-none d-md-flex row text-muted small mb-2 border-bottom pb-2">
                        <div class="col-md-5">Product</div>
                        <div class="col-md-2">Brand</div>
                        <div class="col-md-2 text-center">Price</div>
                        <div class="col-md-1 text-end">QTY</div>
                        <div class="col-md-2 text-end">Total</div>
                    </div>

                    {% for item in orderitem_with_image %}
                        <div class="row align-items-center product-item py-3">
                            <!-- Product Info -->
                            <div class="col-8 col-md-5 d-flex align-items-center">
                                <a href="{% url 'shop_productdetail' item.order_item.product.id %}">
                                    <img src="{{item.main_image.image.url}}" alt="Product" class="product-image me-2">
                                </a>
                                <div class="overflow-hidden">
                                    <p class="mb-0 fw-bold text-truncate">{{item.order_item.product.name}}</p>
                                    <span class="text-muted extra-small d-block">Var: {{item.order_item.variant.name}}</span>
                                    
                                    <div class="mt-1">
                                        {% if not item.order_item.is_cancel %}
                                            {% if order.status != 'Delivered' and order.status != 'Shipped' and order.status != 'Payment Failed' %}
                                                {% if not item.order_item.is_return %}
                                                    <form action="{% url 'cancel_order_item' item.order_item.order.id item.order_item.id %}" method="POST" class="delete-form">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-link btn-outline-dark text-danger extra-small text-decoration-none badge bg-muted rounded-pill border-dark">Cancel item</button>
                                                    </form>
                                                {% endif %}    
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-danger rounded-pill extra-small">Cancelled</span>
                                        {% endif %}
                                        {% if item.order_item.is_return %}
                                            <span class="badge bg-warning text-dark rounded-pill extra-small">Returned</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Mobile view helper: brand/price grouped for small screens -->
                            <div class="col-4 d-md-none text-end small">
                                <span class="fw-bold d-block">₹{{item.order_item.total_price}}</span>
                                <span class="text-muted">{{item.order_item.quantity}} pcs</span>
                            </div>

                            <!-- Desktop columns -->
                            <div class="col-md-2 d-none d-md-block small text-truncate">
                                <a href="#" class="sku-link">{{item.order_item.product.brand.name}}</a>
                            </div>
                            <div class="col-md-2 d-none d-md-block text-center small">₹{{item.order_item.real_price}}</div>
                            <div class="col-md-1 d-none d-md-block text-end small">{{item.order_item.quantity}}</div>
                            <div class="col-md-2 d-none d-md-block text-end fw-bold">
                                <p class="m-0">₹{{item.order_item.total_price}}</p>
                                <span class="text-success extra-small">-₹{{item.order_item.sub_discount}}</span>
                            </div> 

                            <!-- Action Buttons for Delivered -->
                            {% if order.status == 'Delivered' and not item.order_item.is_cancel %}
                                <div class="col-12 mt-2 d-flex justify-content-end gap-1">
                                    {% if not item.order_item in return_items %}
                                        <a href="{% url 'product_rating' %}?variant_id={{item.order_item.variant.id}}&order_id={{item.order_item.order.id}}" class="rating-btn">Rate</a>
                                    {% endif %}
                                    {% if not order.return_requests.reason and not item.order_item in return_items %}
                                        <a href="{% url 'return_order_item' order.id item.order_item.id %}" class="return-item-btn">Return</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
    
                    <!-- Totals Section -->
                    <div class="totals-section mt-3">
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="text-muted">Total MRP:</span>
                            <span>₹{{order.total_items_amount}}</span>
                        </div>
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="text-success">Discount:</span>
                            <span class="text-success">-₹{{order.total_discount}}</span>
                        </div>
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="text-muted">Subtotal:</span>
                            <span>₹{{order.total_amount}}</span>
                        </div>
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="text-muted">Coupon:</span>
                            <span>-₹{{order.coupon_amount}}</span>
                        </div>
                        <div class="d-flex justify-content-between py-1 small">
                            <span class="text-muted">Tax:</span>
                            <span>+₹{{order.tax_amount}}</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between py-1 fw-bold h6">
                            <span>Grand Total</span>
                            <span>₹{{order.over_all_amount}}</span>
                        </div>
                    </div>
                </div>
    
                <!-- Action Buttons Bottom -->
                <div class="d-flex flex-wrap justify-content-end gap-2 mt-4">
                    <button onclick="history.back()" class="btn btn-outline-dark">Go Back</button>
                    
                    {% if order.status != 'Delivered' and order.status != 'Shipped' and order.status != 'Cancelled' and order.status != 'Payment Failed' and order.status != 'Returned' %}
                    <a href="{% url 'cancel_order' order.id %}" class="btn btn-danger">Cancel Order</a>
                    {% endif %}

                    {% if order.status == 'Delivered' and not return_item_requests and not order.return_requests.reason %}
                    <a href="{% url 'return_order' order.id %}" class="btn btn-danger">Return Order</a>
                    {% endif %}

                    {% if order.status == 'Payment Failed' and order.razorpay_order_id %}
                    <a href="#" class="btn btn-primary">Retry Payment</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.querySelectorAll('.delete-form').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        Swal.fire({
          title: 'Are you sure?',
          text: "Cancel this item from your order?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, cancel!',
          customClass: {
            confirmButton: 'btn btn-danger me-2',
            cancelButton: 'btn btn-dark'
          },
          buttonsStyling: false
        }).then((result) => {
          if (result.isConfirmed) { form.submit(); }
        });
      });
    });
</script>

{% if messages %}
{% for message in messages %}
<script>
    Swal.fire({
      icon: "{% if message.tags == 'error' %}error{% elif message.tags == 'success' %}success{% else %}info{% endif %}",
      title: "{{ message }}",
      showConfirmButton: false,
      timer: 2000
    });
</script>
{% endfor %}
{% endif %}
{% endblock %}